name: CppCheck

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-20.04

    # env:
    #   TIMESTAMP: $(date +"%Y-%m-%d %H-%M-%S")
    #   ARTIFACT_NAME: "cppcheck-report-${{ env.TIMESTAMP }}-${{ github.sha }}"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set Timestamp and Artifact Name
      run: |
        TIMESTAMP=$(date +"%Y-%m-%d %H-%M-%S")
        ARTIFACT_NAME="cppcheck-report-${TIMESTAMP}-${GITHUB_SHA}"
        echo "Timestamp: $TIMESTAMP"
        echo "Artifact Name: $ARTIFACT_NAME"
        echo "GITHUB_SHA: $GITHUB_SHA"
        echo "::set-env name=TIMESTAMP::$TIMESTAMP"
        echo "::set-env name=ARTIFACT_NAME::$ARTIFACT_NAME"

    - name: Setup CMake
      uses: lukka/run-cmake@v1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y 
        sudo apt-get install -y cppcheck

    - name: Run CppCheck
    #   ##run: cppcheck --enable=all --xml --xml-version=2 --check-config --std=c++11 .
      run: cppcheck --enable=all --force --inconclusive --xml --xml-version=2 --output-file=cppcheck-report.xml .
    #   ##run: cppcheck --enable=all --xml --xml-version=2 .

    - name: Upload CppCheck results
      uses: actions/upload-artifact@v2
      with:
        name: cppcheck-report-${{ env.ARTIFACT_NAME }}
        path: ./cppcheck-report.xml

    # - name: Create artifact
    #   run: |
    #     TIMESTAMP=$(date +"%Y-%m-%d %H-%M-%S")
    #     ARTIFACT_NAME="cppcheck-report-${TIMESTAMP}-${{ github.sha }}"
    #     echo "Artifact Name: $ARTIFACT_NAME"